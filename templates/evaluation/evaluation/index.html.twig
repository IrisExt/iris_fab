{% extends 'base.html.twig' %}
{% trans_default_domain 'Evaluations' %}

{% block title %}{{ 'evaluation.evaluation'|trans }}{% endblock %}

{% block stylesheets1 %}
    <style>
        .sort_tab { cursor: pointer; }
    </style>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
{% endblock %}

{% block navmenu %}
    <span class="bread-slash">/</span>
    <li><a href={{ path('evaluations') }}><b>{{ 'evaluation.evaluations'|trans }}</b></a></li>
{% endblock %}

{% block body %}
<div class="breadcome-area mg-b-30 small-dn">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcome-list shadow-reset">
                    <div class="row">
                        <div class="col-md-7">{% include 'evaluation/evaluation/evaluation.legende.html.twig'  with statusEvaluations %}</div>
                        <div class="col-md-5">
                            <div class="breadcome-heading has-feedback">
                                <input id="filter" type="text" placeholder="Recherche..." class="form-control" style="width:100%">
                                <i class="glyphicon glyphicon-search form-control-feedback"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="data-table-area mg-b-15">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="sparkline13-list shadow-reset">
                    <div class="sparkline12-hd">

                            <div class="datatable-dashv1-list custom-datatable-overright">
                                <!-- tableau -->
                                <table class="table table-condensed table-striped table-hover tablesorter ui-table-reflow" id="sortTable" >
                                    <thead>
                                    <tr>
                                        <th><h5>{{ 'evaluation.projet'|trans }}<span class="sort_tab fa fa-fw fa-sort"></span></h5></th>
                                        <th><h5>{{ 'evaluation.criticite'|trans }}<span class="sort_tab fa fa-fw fa-sort"></span></h5></th>
                                        <th><h5>{{ 'evaluation.evaluations'|trans }}</h5></th>
                                        <th><h5>{{ 'evaluation.rapporteur'|trans }}<span class="sort_tab fa fa-fw fa-sort"></span></h5></th>
                                        <th><h5>{{ 'evaluation.lecteurs'|trans }}<span class="sort_tab fa fa-fw fa-sort"></span></h5></th>
                                        <th><h5>{{ 'evaluation.action'|trans }}</h5></th>
                                        <th><h5>{{ 'evaluation.langue'|trans }}<span class="sort_tab fa fa-fw fa-sort"></span></h5></th>
                                        <th><h5>{{ 'evaluation.recuse'|trans }}<span class="sort_tab fa fa-fw fa-sort"></span></h5></th>
                                    </tr>
                                    </thead>
                                    <tbody class="searchable">
                                    {% for projet in projets %}
                                    <tr>
                                        <td>
                                            {% if projet.idComite.IdLangue is defined  %}
                                                {% if projet.idComite.IdLangue == 1 %}
                                                    <a href="{{ path('evaluations_project', {'idProjet': projet.idProjet}) }}">
                                                        {{ projet.lbTitreFr }}
                                                    </a>
                                                {% else %}
                                                    <a href="{{ path('evaluations_project', {'idProjet': projet.idProjet}) }}">
                                                        {{ projet.lbTitreEn }}
                                                    </a>
                                                {% endif %}
                                            {% else %}
                                                <a href="{{ path('evaluations_project', {'idProjet': projet.idProjet}) }}">
                                                    {{ projet.lbTitreFr }}
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set criticite = projet.criticite %}
                                            {% include 'evaluation/evaluation/evaluation.criticite.html.twig' with criticite %}</td>
                                        <td>
                                            <div>
                                                {% set experts = projet.tgAffectations %}
                                                {% include 'evaluation/evaluation/evaluation.panel.html.twig' with experts %}
                                            </div>       
                                        </td>
                                        <td>
                                            {% set rapporteurs = projet.tgAffectations|filter(affect => affect.idStAffect.lbNom == 'Rapporteur')  %}
                                            {% for rapporteur in rapporteurs %}
                                                {{ rapporteur.idPersonne.lbNomUsage|upper }} {{ rapporteur.idPersonne.lbPrenom|capitalize }} ({{ projet.tgAffectations|filter(affect => affect.idPropose == rapporteur.idPersonne)|length }})
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% set lecteurs = projet.tgAffectations|filter(affect => affect.idStAffect.lbNom == 'Lecteur') %}
                                            {% for lecteur in lecteurs %}
                                                {{ lecteur.idPersonne.lbNomUsage|upper }} {{ lecteur.idPersonne.lbPrenom|capitalize }} ({{ projet.tgAffectations|filter(affect => affect.idPropose == lecteur.idPersonne)|length }})
                                            {% endfor %}
                                        </td>
                                        <td></td>
                                        <td>
                                            {% set doc = projet.tgDocument|filter(doc => doc.idTypeDoc == '1')|first %}
                                            {% if doc is not empty %}
                                                {% if doc.idLangue is not empty %}
                                                    {{ doc.idLangue.cdLangue }}
                                                {% else %}
                                                    no language
                                                {% endif %}
                                            {% else %}
                                                no doc
                                            {% endif %}
                                        </td>
                                        <td></td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                {% include 'tg_message/modal/modalMessageCes.html.twig' %} <!-- modal message cps ... -->
                                <div class="footer-text-center">
                                    {{ knp_pagination_render(projets) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block javascripts %}

<script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.24.6/js/jquery.tablesorter.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.24.6/js/jquery.tablesorter.widgets.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.24.6/js/widgets/widget-columnSelector.min.js"></script>

<script>
    $(document).ready(function(){
        (function ($) {
            $('#filter').keyup(function () {
                var rex = new RegExp($(this).val(), 'i');
                $('.searchable tr').hide();
                $('.searchable tr').filter(function () {
                    return rex.test($(this).text());
                }).show();
            })
        }(jQuery));

        $("#sortTable")
            .tablesorter({
                // Enable filter
                widgets: ["filter"],
                widgetOptions: {
                    filter_columnFilters: false,
                    filter_searchDelay: 60,
                    filter_useParsedData: true
                },
                sortList: [
                    [1]
                ]
            });
    });
</script>

{% endblock %}
