{% extends 'base_soumission.html.twig' %}

{% trans_default_domain 'Blocs' %}
{% block stylesheets %}
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/duallistbox/bootstrap-duallistbox.min.css') }}">
    <link rel="stylesheet" href="{{ asset('css/chosen/bootstrap-chosen.css') }}">

    <style>
     .rightButton {
            color: #fff;
            background-color: #337ab7;
            border-color: #2e6da4;
            float: right;
     }
     .d-block {
         color: crimson;
         font-size: 11px;
         display: ruby-base;
     }
     .badge {
         background-color: #dd1717;
         font-size: 10px;
     }
    </style>
{% endblock %}

{% block title %}{% endblock %}

{% block body %}
    {% include 'bloc/list_blocs.html.twig' with { list_bloc:list_bloc, formulaire:formulaire, projet:projet, id_instrument:id_instrument, blocValidation:blocValidation } %}
    <div class="col-sm-9">
        {% block content %}

        <div class="advanced-form-area mg-b-15">
            <div class="container-fluid">
                <div class="row">
                    <div class="sparkline8-list shadow-reset">
                        <div class="sparkline8-hd">
                            <div class="main-sparkline8-hd">
                                <h1>{% for bloc in list_bloc %} {% if bloc.id_bloc == idBloc %} {{ bloc.libelle }} {% endif %} {% endfor %}</h1>
                            </div>
                        </div>
                        <div class="sparkline8-graph">
                            {{ form_start(bloc) }}
                             <div class="form-group row">
                                    <div class="col-sm-1"></div>
                            <div class="col-sm-11">
                            <div id="BlIdentProjType_Acr">
                                {{ form_row(bloc.lbAcro, {'label_attr': {'class': 'required'}}) }}
                            </div>
                            <div id="BlIdentProjType_TitFr">
                                {{ form_row(bloc.lbTitreFr, {'label_attr': {'class': 'required'}}) }}
                            </div>
                            <div id="BlIdentProjType_TitEn">
                                {{ form_row(bloc.lbTitreEn) }}
                            </div>
                            <div id="BlIdentProjType_Duree">
                                {{ form_row(bloc.noDuree, {'label_attr': {'class': 'required'}}) }}
                            </div>
                            <div id="BlIdentProjType_TypeRech">
                                {{ form_row(bloc.idCatRd) }}
                            </div>
                            <div id="BlIdentProjType_Inst">
                                {{ form_row(bloc.idInfraFi) }}
                            </div>
                            <div id="BlIdentProjType_Ces">
                                {{ form_row(bloc.idComite, {'label_attr': {'class': 'required'}}) }}
                            </div>
                            <div id="BlIdentProjType_MntPrev">
                             {{ form_row(bloc.mntAidePrev, {'label_attr': {'class': 'required'}}) }}
                             {% if(MntMax and MntMin) %}
                             <div class="row">
                             <div class="col-sm-2"></div>
                             <div class="col-sm-10"><p>Montant min et max de l'instrument de financement : {{ MntMin }} K€ - {{ MntMax }} K€</p></div>{% endif %}
                            </div>
                             </div>
                             <br><br><br>
                              <div>
                                  <div class="col-md-6 col-sm-3"></div>
                                  <div class="col-md-2 col-sm-3">  <a href="{{ previousblock }}" class="btn btn-primary pull-right"><< Précédent</a> </div>
                                  <div class="col-md-2 col-sm-3"> {{ form_widget(bloc.saveBlocWithoutRedirect) }} </div>
                                  <div class="col-md-2 col-sm-3"> {{ form_widget(bloc.saveBloc) }} </div>
                              </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                         {{ form_widget(bloc.saveFormulaire, { 'attr': {'class': 'hidden'} }) }}
                                    </div>
                                </div>
                            {{ form_end(bloc) }}
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
        </div>
    </div>
</div>
{% endblock %}

        {% block javascripts %}

            <script>
                $(function() {

                    function checkProvisionalAmount(ProAmount) {

                        var ProAmnt = ProAmount.val();
                        var MntMin = "{{ MntMin }}";
                        var MntMax = "{{ MntMax }}";

                          if((parseInt(MntMax) < parseInt(ProAmnt)) || (parseInt(MntMin) > parseInt(ProAmnt))) {
                             ProAmount.css("border-color", "#a23e3e");
                              $('#BlIdentProjType_saveBloc').attr('disabled','disabled');
                                $('#BlIdentProjType_saveBlocWithoutRedirect').attr('disabled','disabled');
                               var error_bloc = '<span id="error_ProAmnt" class="invalid-feedback d-block"><span class="d-block"><span class="form-error-icon badge badge-danger text-uppercase">Erreur</span><span class="form-error-message"> Le montant provisionnel d\'aide doit être entre le montant max et min de l\'instrument de financement</span></span></span>';
                              $( error_bloc ).insertAfter(ProAmount);
                            }else {
                              ProAmount.css("border-color", "#66afe9");
                                $('#BlIdentProjType_saveBloc').attr('disabled',false);
                                 $('#BlIdentProjType_saveBlocWithoutRedirect').attr('disabled', false);
                                 $('#error_ProAmnt').remove();
                            }
                    }
                    function errorLbAcro(lbacronyme, acro) {
                        var lbacro = lbacronyme.val();
                          if(acro.toLowerCase().trim() === lbacro.toLowerCase().trim()) {
                             lbacronyme.css("border-color", "#a23e3e");
                              $('#BlIdentProjType_saveBloc').attr('disabled','disabled');
                               $('#BlIdentProjType_saveBlocWithoutRedirect').attr('disabled','disabled');
                               var error_bloc = '<span id="error_lbacro" class="invalid-feedback d-block"><span class="d-block"><span class="form-error-icon badge badge-danger text-uppercase">Erreur</span><span class="form-error-message"> Acronyme déjà existant pour cet appel à projet</span></span></span>';
                              $( error_bloc ).insertAfter(lbacronyme);
                            }

                    }
                     function errorLbAcroRemove(lbacronyme, acro) {
                         var lbacro = lbacronyme.val();

                          if(acro.toLowerCase().trim() !== lbacro.toLowerCase().trim()) {
                          lbacronyme.css("border-color", "#66afe9");
                                 $('#BlIdentProjType_saveBloc').attr('disabled',false);
                                  $('#BlIdentProjType_saveBlocWithoutRedirect').attr('disabled', false);
                                  $('#error_lbacro').remove();
                           }
                     }
                     errorLbAcro($("#BlIdentProjType_lbAcro"), "{{ lbAcro }}" );

                     $('#error_lbacro').remove();

                     $("#BlIdentProjType_lbAcro").keyup(function() {
                           $('#error_lbacro').remove();
                         errorLbAcro($(this), "{{ lbAcro }}");
                           {% if(acros) %}
                            {% for acro in acros %}
                     errorLbAcroRemove($(this), "{{ acro }}");
                      {% endfor %}
                    {% for acro in acros %}
                     errorLbAcro($(this), "{{ acro }}");
                      {% endfor %}
                    {% endif %}

                     });

                     checkProvisionalAmount($("#BlIdentProjType_mntAidePrev"));
                     $("#BlIdentProjType_mntAidePrev").keyup(function() {
                          $('#error_ProAmnt').remove();
                         checkProvisionalAmount($(this));
                     });

                    {% if(errors) %}
                    {% for error in errors %}
                    var error_bloc = '<span class="invalid-feedback d-block"><span class="d-block"><span class="form-error-icon badge badge-danger text-uppercase">Erreur</span><span class="form-error-message"> {{ error.message }}</span></span></span>';
                  //  $( error_bloc ).insertAfter( $( "#BlIdentProjType_{{ error.field }}" ) );
                    if("noDuree" == "{{ error.field }}")  $( error_bloc ).insertAfter( $( "#BlIdentProjType_{{ error.field }}_chosen" ) );
                    else  $( error_bloc ).insertAfter( $( "#BlIdentProjType_{{ error.field }}" ) );
                    {% endfor %}
                    {% endif %}
                });

            </script>
              <script src="{{ asset('js/chosen/chosen.jquery.js') }}"></script>
    <script src="{{ asset('js/chosen/chosen-active.js') }}"></script>
        {% endblock %}