{% extends 'base_soumission.html.twig' %}

{% trans_default_domain 'Blocs' %}
{% block stylesheets %}
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/duallistbox/bootstrap-duallistbox.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/font-awesome.min.css') }}">
    <link type="text/css" rel="stylesheet" href="{{ asset('bundles/craueformflow/css/buttons.css') }}"/>
    <link rel="stylesheet" href="{{ asset('css/modals.css') }}">
    <link type="text/css" rel="stylesheet" href="{{ asset('css/data-table/bootstrap-table.css') }}"/>
    <link type="text/css" rel="stylesheet" href="{{ asset('css/data-table/bootstrap-editable.css') }}" />
    <style>
        .rightButton {
            color: #fff;
            background-color: #337ab7;
            border-color: #2e6da4;
            float: right;
        }
        .d-block {
            color: crimson;
            font-size: 11px;
            display: ruby-base;
        }
        .badge {
            background-color: #dd1717;
            font-size: 10px;
        }

        .duallistbox{
            width: 100%;
        }
        .form-check {
            display: flex;
            margin-right: 20px;
        }
        .form-check-input {
            margin-right: 10px !important;
            margin-bottom: auto !important;
        }

        #BlInfoComplType_blDemLabel { display: flex }
        #BlInfoComplType_blInfraRecherche { display: flex}
        #BlInfoComplType_blDemCofi { display: flex}

        .title_sous_bloc {
            background: #E2E7F0;
            padding: 15px 0px 5px 15px;
            margin-bottom: 50px;
        }
        fieldset {
            border: 0 !important;
        }
        .select_sousblock {
            text-decoration: none;
            background-color: #eee;
        }
        .nav-link.active {
            text-decoration: none;
            background-color: #E2E7F0;
        }

        [data-title]:hover::before {


            background: #fff;
            color: #000;
            font-size: 12px;

        }
        [data-title]:hover::after {

            color: #000;

        }
    </style>
{% endblock %}

{% block title %}{% endblock %}

{% block body %}
        {% include 'bloc/list_blocs.html.twig' with { list_bloc:list_bloc, formulaire:formulaire, projet:projet, id_instrument:id_instrument, blocValidation:blocValidation } %}
        <div class="col-sm-9">
            {% block content %}
            <div class="advanced-form-area mg-b-15">
                <div class="container-fluid">
                    <div class="row">
                        <div class="sparkline8-list shadow-reset">
                            <div class="sparkline8-hd">
                                <div class="main-sparkline8-hd">
                                    <h1>{% for bloc in list_bloc %} {% if bloc.id_bloc == idBloc %} {{ bloc.libelle }} {% endif %} {% endfor %}</h1>
                                </div>
                            </div>

                            <div class="sparkline8-graph">
                                <div class="">
                            <div class="row">
                                 <div class="col-sm-12">
                                {{ form_start(bloc) }}

                                <ul class="nav nav-tabs" id="myTab" role="tablist">

                                    <li class="nav-item active">
                                        <a class="nav-link" id="pc-tab" data-toggle="tab" href="#pc" role="tab" aria-controls="pc" aria-selected="true">
                                            Pôles de compétitivité
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="ir-tab" data-toggle="tab" href="#ir" role="tab" aria-controls="ir" aria-selected="true">
                                            Infrastructure(s) de recherche (IR)
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="co-tab" data-toggle="tab" href="#co" role="tab" aria-controls="co" aria-selected="true">
                                            Cofinancement
                                        </a>
                                    </li>

                                </ul>

                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade active in" id="pc" role="tabpanel" aria-labelledby="pc-tab">
                                        <br><br><br>
                                        {% include 'bloc/SousBlockPolesComp.html.twig' with { bloc:bloc, NbPolCompMax:NbPolCompMax  } %}
                                    </div>
                                    <div class="tab-pane fade" id="ir" role="tabpanel" aria-labelledby="ir-tab">
                                        <br><br><br>
                                        {% include 'bloc/SousBlockInfraRecherche.html.twig' with { bloc:bloc, NbStructRechMax:NbStructRechMax } %}
                                    </div>
                                    <div class="tab-pane fade" id="co" role="tabpanel" aria-labelledby="co-tab">
                                        <br><br><br>
                                        {% include 'bloc/SousBlockCofinancement.html.twig' with { bloc:bloc, NbCOMax:NbCOMax } %}
                                    </div>
                                </div>


                                 </div>
                            </div>
                                <br><br><br>
                                    <div>
                                        <div class="col-md-6 col-sm-3"></div>
                                        <div class="col-md-2 col-sm-3">  <a href="{{ previousblock }}" class="btn btn-primary pull-right"><< Précédent</a> </div>
                                        <div class="col-md-2 col-sm-3"> {{ form_widget(bloc.saveBlocWithoutRedirect) }} </div>
                                        <div class="col-md-2 col-sm-3"> {{ form_widget(bloc.saveBloc) }} </div>
                                    </div>
                                <div class="form-group row">
                                    <div class="col-sm-12">
                                        {{ form_widget(bloc.saveFormulaire, { 'attr': {'class': 'hidden'} }) }}
                                    </div>
                                </div>
                                {{ form_end(bloc) }}


                                </div>
                            </div>

                        </div>
                        </div>
                    </div>
                </div>
                {% endblock %}
    </div>
{% endblock %}

{% block javascripts %}

    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <script src="{{ asset('js/duallistbox/jquery.bootstrap-duallistbox.js') }}"></script>
    <script src="{{ asset('js/duallistboxcustom.js') }}"></script>
    <script>
        $(document).ready(function() {
            if (location.hash) {
                $("a[href='" + location.hash + "']").tab("show");
            }
            $(document.body).on("click", "a[data-toggle='tab']", function(event) {
                location.hash = this.getAttribute("href");
            });
        });
        $(window).on("popstate", function() {
            var anchor = location.hash || $("a[data-toggle='tab']").first().attr("href");
            $("a[href='" + anchor + "']").tab("show");
        });
        $(function(){

            // function activeBloc() {
            //     var url      = window.location.href;
            //     var index = url.indexOf("#");
            //     var rubrique = url.substr(index+1);
            //
            //     if(-1 === index){
            //         $('#pc').addClass('active');
            //         $('.infocompl').hide();
            //         $('#bl_pc').show();
            //     }else {
            //         $('.nav-link').removeClass('active');
            //         $('#' + rubrique + '').addClass('active');
            //         $('.infocompl').hide();
            //         $('#bl_' + rubrique + '').show();
            //     }
            // }
            //
            // activeBloc();
            //
            // $('.nav-link').click(function(e){
            //     $('.nav-link').removeClass('active');
            //     $(this).addClass('active');
            //     var id = e.target.id;
            //     $('.infocompl').hide();
            //     $('#bl_' + id + '').show();
            // });


            $('#CHOIX_IR').popover({
                title: "Choix des infrastructures",
                content: "{{ CHOIX_IR }}",
                html : true,
                placement:"top"
            });

            $('#CHOIX_CO').popover({
                title: "Choix des cofinancements",
                content: "{{ CHOIX_CO }}",
                html : true,
                placement:"top"
            });

            $('#CHOIX_PC').popover({
                title: "Choix des pôles de compétitivité",
                content: "{{ CHOIX_PC }}",
                html : true,
                placement:"top"
            });

        });

        function dualBox(name, nonSelectedListLabel, selectedListLabel) {
            $('select[name="BlInfoComplType[' + name + '][]"]').bootstrapDualListbox({
                moveAllLabel: 'move all',
                filterPlaceHolder: 'Rechercher...',
                nonSelectedListLabel: nonSelectedListLabel,
                selectedListLabel: selectedListLabel,
                preserveSelectionOnMove: false,
                moveOnSelect: false,
                infoText: 'Liste contient {0} éléments',
                selectorMinimalHeight: 190,
                infoTextEmpty : 'Liste vide'
            });
        }
        var demo1 = dualBox('idPoleComp', 'Les pôles de compétitivité', 'Liste des pôles sélectionnés pour le projet');
        var demo2 = dualBox('idInfRech', 'Les infrastructures de recherche', 'Liste des infrastructures sélectionnées pour le projet');
        var demo3 = dualBox('idCoFi', 'Les co financeurs', 'Liste des co financeurs  sélectionnés pour le projet');

        $(function () {
            $('[data-toggle=tooltip]').tooltip();
        });

       //var demo1 = $('select[name="BlInfoComplType[idPoleComp][]"]');

        function dualBoxChange(name, maxLimit, bloc) {
            var demo = $('select[name="BlInfoComplType[' + name + '][]"]');
            demo.on('change', function(){
                var size = demo.find(":selected").size();

                if(size > maxLimit-1){
                     demo.find(":selected").each(function(ind, sel){
                         $('#' + bloc + '').find('.moveall').attr("hidden", true);
                         $('#' + bloc + '').find('.move').attr("hidden", true);
                         if(ind > maxLimit-1)
                            $(this).prop("selected", false)
                     })
                    demo.bootstrapDualListbox('refresh', true);
                } else {
                    $('#' + bloc + '').find('.moveall').attr("hidden", false);
                    $('#' + bloc + '').find('.move').attr("hidden", false);
                    demo.bootstrapDualListbox('refresh', true);
                }
            });

        }

        dualBoxChange('idPoleComp', {{NbPolCompMax}}, 'poles');
        dualBoxChange('idInfRech', {{NbStructRechMax}}, 'infras');
        dualBoxChange('idCoFi', {{NbCOMax}}, 'cofis');

        if (0 == $('input[name="BlInfoComplType[blDemLabel]"]:checked').val()) $("#poles").hide();
        if (0 == $('input[name="BlInfoComplType[blInfraRecherche]"]:checked').val() ) $("#infras").hide();
        if (0 == $('input[name="BlInfoComplType[blDemCofi]"]:checked').val()) $("#cofis").hide();

        $('input[name="BlInfoComplType[blDemLabel]"]').change(function () {
            $("#poles").toggle();
        });

        $('input[name="BlInfoComplType[blInfraRecherche]').change(function () {
            $("#infras").toggle();
        });

        $('input[name="BlInfoComplType[blDemCofi]').change(function () {
           $("#cofis").toggle();
        });

        $('[data-toggle="tooltip"]').tooltip({ placement : 'left', html : true });

        $('#infras select option').each(function() {
            $(this).attr('data-toggle', "tooltip");
            $(this).attr('data-container', "#tooltip_container");
        });

        $('#infras select option').each(function() {
            var e = $(this).val();
            {% for infra in infras %}
            if({{ infra.idInfRech }} == e)  $(this).attr('data-title', "{{ infra.lbNomLong }}");
            {% endfor %}
        });

        {#demo2.element.find('option').each(function(index, item) {#}
        {#    var e = $(this).val();#}
        {#    {% for infra in infras %}#}
        {#    if({{ infra.idInfRech }} == e)  $(this).attr('data-title', "{{ infra.lbNomLong }}");#}
        {#    {% endfor %}#}
        {#});#}


        {% if(errors) %}
        {% for error in errors %}
        var error_bloc = '<span class="invalid-feedback d-block"><span class="d-block"><span class="form-error-icon badge badge-danger text-uppercase">Erreur</span><span class="form-error-message"> {{ error.message }}</span></span></span>';
        if('idPoleComp[id_pole_comp]' === "{{ error.field }}"){
               $( error_bloc ).insertAfter( $( "#BlInfoComplType_idPoleComp" ) );
         }
        if('idInfRech[id_inf_rech]' === "{{ error.field }}"){
            $( error_bloc ).insertAfter( $( "#BlInfoComplType_idInfRech" ) );
        }
        if('idCoFi[id_co_fi]' === "{{ error.field }}"){
            $( error_bloc ).insertAfter( $( "#BlInfoComplType_idCoFi" ) );
        }
        {% endfor %}
        {% endif %}

    </script>
{% endblock %}